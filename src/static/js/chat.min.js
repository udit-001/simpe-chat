var recentChatroom="",recentChatroomId=null,unreadMsgCount=0,list_of_people_typing=[],recentlyViewedMsgTime="",users={};document.addEventListener("DOMContentLoaded",function(){function e(e){var t=list_of_people_typing.indexOf(e);list_of_people_typing.splice(t,1),document.querySelector("#typing").style.display="none",document.querySelector(".chat-section").classList.remove("-typing")}function t(e){var t=e.length,n="";if(0===t)return document.querySelector("#typing").style.display="none",void document.querySelector(".chat-section").classList.remove("-typing");if(t<=3)for(i=0;i<t;i++)0===i&&1===t&&(n+=e[i]+" is typing..."),0===i&&1!==t&&(n+=e[i]),1===i&&2===t&&(n+=" and "+e[i]+" are typing..."),1===i&&2!==t&&(n+=" , "+e[i]),2===i&&(n+=" and "+e[i]+" are typing...");else n="Several people are typing...";document.querySelector(".chat-section").classList.add("-typing"),document.querySelector("#typing").style.display="block",document.querySelector("#typing").innerText=n}function n(){document.querySelectorAll("ul#channels > li").forEach(function(e){try{e.onclick=function(t){var n={channel:t.target.innerText.replace("#","").trim()};history.pushState(n,t.target.innerText,"/chat/"+t.target.dataset.channel_id),document.querySelector("#chat").removeAttribute("style"),document.querySelector(".messages-wrapper").innerHTML="",document.querySelector("#chat").style.height=window.innerHeight+"px",document.querySelector("#currentRoom").innerText=`#${e.innerText}`,c.emit("subscribe",{room:e.innerText.trim(),username:localStorage.getItem("username")}),document.querySelectorAll(".selected-li").forEach(function(e){e.classList.remove("selected-li")}),e.classList.add("selected-li"),recentChatroom=e.innerText.trim(),recentChatroomId=e.dataset.channel_id,document.title=`${e.innerText} | Flack : A Chat App`,c.emit("get messages",{room:recentChatroomId}),Boolean($("#ex1")[0].emojioneArea.editor)&&$("#ex1")[0].emojioneArea.editor.focus(),$(window).width()<=800&&($("#sidebar").hide("slide",500),$("#ui-dismiss").hide("fade",500))}}catch(e){console.error(e.message)}}),document.querySelectorAll("ul#users > li").forEach(function(e){try{e.onclick=function(t){var n={channel:t.target.innerText.replace("#","").trim()};history.pushState(n,t.target.innerText,"/chat/"+t.target.dataset.channel_id),document.querySelector("#chat").removeAttribute("style"),document.querySelector(".messages-wrapper").innerHTML="",document.querySelector("#chat").style.height=window.innerHeight+"px",document.querySelector("#currentRoom").innerText=`#${e.innerText}`,document.querySelectorAll(".selected-li").forEach(function(e){e.classList.remove("selected-li")}),e.classList.add("selected-li"),recentChatroom=e.innerText.trim(),recentChatroomId=e.dataset.channel_id,document.title=`${e.innerText} | Flack : A Chat App`,c.emit("get messages",{room:recentChatroomId}),Boolean($("#ex1")[0].emojioneArea.editor)&&$("#ex1")[0].emojioneArea.editor.focus(),$(window).width()<=800&&($("#sidebar").hide("slide",500),$("#ui-dismiss").hide("fade",500)),parties=Array(localStorage.username,e.innerText.trim()),parties.sort(),recentChatroom=parties.join("-"),c.emit("subscribe",{room:recentChatroom,username:localStorage.getItem("username")}),document.querySelector("#send").onclick=function(){const e=localStorage.getItem("username"),t=$("#ex1")[0].emojioneArea.getText().replace(/\s\s+/g," ");if(c.emit("send message",{username:e,message:t,room:recentChatroom,roomId:recentChatroomId,type:"text",utc:Date.now()}),us=document.querySelector("#currentRoom").innerText.replace("#","").trim(),c.emit("notify user",{room:users[us]}),$("#ex1")[0].emojioneArea.setText(""),document.querySelector("#send").disabled=!0,!localStorage.getItem("soundOff")){var n=document.getElementById("sent-message");n.play(),console.log("Sound was played")}return!1}}}catch(e){console.error(e.message)}})}function o(){document.querySelectorAll("h4.inline-block").forEach(function(e){e.onclick=function(){if(e.innerText!==localStorage.username){document.title=`${e.innerText} | Flack : A Chat App`,document.querySelector("#currentRoom").innerText=`#${e.innerText}`,document.querySelector(".messages-wrapper").innerHTML="",document.querySelectorAll(".selected-li").forEach(function(e){e.classList.remove("selected-li")}),parties=Array(localStorage.username,e.innerText),parties.sort(),recentChatroom=parties.join("-"),fetch("/channel",{method:"POST",body:JSON.stringify({channel:recentChatroom,private:!0}),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(t=>{if("true"===t.success){recentChatroomId=t.channel_id,document.title=`${e.innerText} | Flack : A Chat App`,document.querySelectorAll(".selected-li").forEach(function(e){e.classList.remove("selected-li")}),beg=document.createElement("div"),beg.setAttribute("class","beg"),beg.innerText=`This is the beginning of your direct message history with ${document.querySelector("#currentRoom").innerText.replace("# ","@")}.`,document.querySelector(".messages-wrapper").appendChild(beg),li=document.createElement("li"),li.innerHTML=`<i class="fas fa-heart fa-xs"></i> ${e.innerText}`,li.setAttribute("class","selected-li"),li.dataset.channel_id=recentChatroomId;var n={channel:e.innerText};history.pushState(n,e.innerText,"/chat/"+recentChatroomId),li.onclick=function(e){c.emit("get messages",{room:recentChatroomId});var t={channel:e.target.innerText.replace("#","").trim()};history.pushState(t,e.target.innerText,"/chat/"+e.target.dataset.channel_id),document.querySelector("#currentRoom").innerText=`#${li.innerText}`,document.title=`${li.innerText} | Flack : A Chat App`,recentChatroomId=li.dataset.channel_id,parties=Array(localStorage.username,li.innerText.trim()),parties.sort(),recentChatroom=parties.join("-"),document.querySelector(".messages-wrapper").innerHTML=""};var o=document.querySelector("#users");o.appendChild(li),li.scrollIntoView({block:"start",behavior:"smooth"}),c.emit("subscribe",{room:recentChatroom,username:localStorage.getItem("username")}),document.querySelector("#no-of-users").innerText=`(${document.querySelectorAll("ul#users > li").length})`}}).catch(e=>console.error("Error:",e));for(const t of document.querySelectorAll("li"))t.textContent.includes(e.innerText)&&(t?(t.scrollIntoView({block:"start",behavior:"smooth"}),t.click()):console.log("Existing conversation not found!"))}}})}"dark"===localStorage.getItem("theme")&&(document.body.classList.add("dark"),document.querySelector("#theme").innerHTML='Light Theme <i class="fas fa-adjust" style="padding-left:5px;"></i>');var r,a,s,c=io.connect(location.protocol+"//"+document.domain+":"+location.port),l=(r={currentTitle:null,interval:null},a=((e,t)=>{null===r.interval&&(r.currentTitle=document.title,r.interval=window.setInterval(()=>{document.title=document.title===r.currentTitle?e||"You have a new message!":r.currentTitle},t||1e3))}),s=(()=>{null!==r.interval&&(window.clearInterval(r.interval),document.title=r.currentTitle,r.interval=null)}),{on:a,off:s});c.on("someone is typing",function(n){recentChatroom===n.room&&(list_of_people_typing.includes(n.username)||(list_of_people_typing.push(n.username),t(list_of_people_typing),setTimeout(e,8e3,n.username)))}),c.on("new dm",function(){c.emit("get users",{user:localStorage.username})}),$("#ex1").emojioneArea({pickerPosition:"top",filtersPosition:"top",placeholder:"Type a message",searchPlaceholder:"Search",tones:!1,textcomplete:{maxCount:3,placement:"top"},events:{keyup:function(e,t){$("#ex1")[0].emojioneArea.getText().length<=0?document.querySelector("#send").disabled=!0:document.querySelector("#send").disabled=!1,13==t.which&&$("#ex1")[0].emojioneArea.getText().length>0&&$("#send").click()},keypress:function(e,t){c.emit("typing",{room:recentChatroom,username:localStorage.getItem("username")})}}}),document.querySelector("#add-channel").onclick=function(){var e=location.protocol+"//"+document.domain+":"+location.port+"/channel";Swal({title:"Create a channel",input:"text",confirmButtonColor:"#4D384B",inputAttributes:{autocapitalize:"off",placeholder:"e.g. leads"},showCancelButton:!0,confirmButtonText:"Create channel",showLoaderOnConfirm:!0,inputValidator:e=>new Promise(t=>{e.length<100?t():t("Must be between 1 and 100 in length")}),preConfirm:t=>{str=t,str=str.replace(/\s+/g,"-").toLowerCase(),str=str.replace(/[!"#$%&'()*+,\.\/ :;<=>?@[\\\]^_`{|}~]+/g,""),t=str;var o={channel:`${t}`};return fetch(e,{method:"POST",body:JSON.stringify(o),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{if("false"===e.success)"Already exists"===e.reason?Swal.showValidationMessage("Channel name already in use, try again."):"Limit reached"===e.reason&&Swal.showValidationMessage("Limit reached, more channels cannot be created.");else{const e=document.querySelector("#channels"),o=document.createElement("li");o.innerHTML=`<i class="fas fa-hashtag fa-xs"></i> ${t}`,e.appendChild(o),document.querySelector("#no-of-channels").innerText=`(${e.children.length})`,n(),c.emit("new channel",{room:t})}}).catch(e=>{Swal.showValidationMessage(`Channel could not be created: ${e}`)})},allowOutsideClick:()=>!Swal.isLoading()}).then(e=>{e.value&&Swal({title:"Channel created successfully!",type:"success"}),document.querySelector("#chat").removeAttribute("style"),document.querySelector("#channels").children[document.querySelector("#channels").children.length-1].click()})},c.on("channel created",function(e){try{for(document.querySelector("#channels").innerHTML="",i=0;i<e.channels.length;i++){const t=document.querySelector("#channels"),n=document.createElement("li");n.innerHTML=`<i class="fas fa-hashtag fa-xs"></i> ${e.channels[i]}`,t.appendChild(n)}document.querySelector("#no-of-channels").innerText=`(${e.channels.length})`,n(),document.querySelector("#chat").removeAttribute("style"),document.querySelector(".selected-li")}catch(e){console.error(e.message)}}),c.on("total channels",function(e){try{for(e.channels.length<=0?document.querySelector("#no-channel").style.display="flex":document.querySelector("#chat").removeAttribute("style"),document.querySelector("#channels").innerHTML="",i=0;i<e.channels.length;i++){const t=document.querySelector("#channels"),n=document.createElement("li");n.innerHTML=`<i class="fas fa-hashtag fa-xs"></i> ${e.channels[i][1]}`,n.dataset.channel_id=e.channels[i][0],t.appendChild(n)}document.querySelector("#no-of-channels").innerText=`(${e.channels.length})`,n(),document.querySelector("#channels").children[0].click();var t=document.querySelector("#channels").children;for(i=0;i<t.length;i++)t[i].innerText.trim()===e.recentChatroom&&(document.querySelector(".messages-wrapper").innerHTML="",t[i].click(),document.querySelector("#sidebar").style.height=window.innerHeight+"px",document.querySelector("#chat").style.height=window.innerHeight+"px")}catch(e){console.error(e.message)}}),c.on("total users",function(e){try{document.querySelector("#users").innerHTML="";const t=document.querySelector("#users");for(i=0;i<e.users.length;i++){const n=document.createElement("li");e.users[i]===localStorage.getItem("username")?(n.innerHTML=`<i class="fas fa-heart fa-xs"></i> ${e.users[i]}(Me)`,document.querySelector("#users").insertBefore(n,t.firstChild)):(n.innerHTML=`<i class="fas fa-heart fa-xs"></i> ${e.users[i][1]}`,n.dataset.channel_id=e.users[i][0],document.querySelector("#users").appendChild(n))}n(),document.querySelector("#no-of-users").innerText=`(${e.users.length})`}catch(e){console.error(e.message)}}),document.querySelector("#send").disabled=!0;const u=localStorage.getItem("username");c.on("connect",function(e){try{c.emit("server connect",{id:c.id,username:localStorage.username}),document.querySelector("#send").onclick=function(){const e=localStorage.getItem("username"),t=$("#ex1")[0].emojioneArea.getText().replace(/\s\s+/g," ");if(c.emit("send message",{username:e,message:t,room:recentChatroom,roomId:recentChatroomId,type:"text",utc:Date.now()}),$("#ex1")[0].emojioneArea.setText(""),document.querySelector("#send").disabled=!0,!localStorage.getItem("soundOff")){var n=document.getElementById("sent-message");n.play(),console.log("Sound was played")}return!1},c.emit("get channels"),c.emit("get users",{user:localStorage.username}),c.emit("new user",{user:localStorage.getItem("username")})}catch(e){console.error(e.message)}});var d=io("/private");d.on("new_private_message",function(e){console.log(`${e.sender} says ${e.message}`)}),c.on("user joined",function(e){users[e.username]=e.id}),c.on("user left",function(e){try{document.querySelector("#users").innerHTML="";const t=document.querySelector("#users");for(i=0;i<e.users.length;i++){const n=document.createElement("li");e.users[i]===localStorage.getItem("username")?(n.innerHTML=`<i class="fas fa-heart fa-xs"></i> ${e.users[i]}(Me)`,t.insertBefore(n,t.firstChild)):(n.innerHTML=`<i class="fas fa-heart fa-xs"></i> ${e.users[i]}`,t.appendChild(n))}e.user===localStorage.getItem("username")&&(localStorage.removeItem("username"),document.location.pathname="/")}catch(e){console.error(e.message)}}),c.on("announce message",function(e){try{var n=Intl.DateTimeFormat().resolvedOptions().timeZone;if(recentChatroomId===e.roomId){const i=document.querySelector(".messages-wrapper"),a=document.createElement("div");a.setAttribute("class","message-div");const s=document.createElement("img");s.setAttribute("class","avatar img-body"),s.setAttribute("src",`https://www.gravatar.com/avatar/${e.md5}?d=identicon&s=50`);const c=document.createElement("div");c.setAttribute("class","message");const u=document.createElement("div"),d=document.createElement("h4");d.setAttribute("class","inline-block"),d.innerText=e.username;const m=document.createElement("h6");m.setAttribute("class","inline-block"),console.log(e.utc),m.innerText=moment.tz(e.utc,n).calendar(),u.appendChild(d),u.appendChild(m),c.appendChild(u);const h=document.createElement("p");if(h.setAttribute("class","text-body"),1==e.is_file?h.innerHTML=`has sent an attachment : <a class="attachment" href="${e.message}" download='${e.file_name}' title='Download ${e.file_name}'>${e.file_name}</a>`:h.innerText=e.message,c.appendChild(h),a.appendChild(s),a.appendChild(c),shouldScroll=Math.floor(i.scrollTop+i.clientHeight)===i.scrollHeight,i.appendChild(a),shouldScroll?(a.scrollIntoView({block:"start",behavior:"smooth"}),recentlyViewedMsgTime=m.innerText,document.querySelector("#unread").style.display="none",document.querySelector(".chat-section").classList.remove("-unread")):(++unreadMsgCount,document.querySelector("#unread").style.display="block",document.querySelector(".chat-section").classList.add("-unread"),document.querySelector("#unread").innerHTML=`<i class="fas fa-long-arrow-alt-up" id="scrollUp"></i>${unreadMsgCount} new messages since ${recentlyViewedMsgTime}`),document.hidden&&l.on(),list_of_people_typing.includes(e.username)){var o=list_of_people_typing.indexOf(name);list_of_people_typing.splice(o,1),t(list_of_people_typing)}if(!localStorage.getItem("soundOff")&&e.username!==localStorage.getItem("username")){var r=document.getElementById("new-message");r.play(),console.log("Sound was played")}}else{const t=document.querySelector("#channels").children;for(i=0;i<t.length;i++)t[i].innerText===e.room&&(t[i].style.color="white")}}catch(e){console.error(e.message)}}),c.on("total messages",function(e){try{var t=Intl.DateTimeFormat().resolvedOptions().timeZone;for(begNote="",recentChatroom.includes(localStorage.username)?begNote=`This is the beginning of your direct message history with ${document.querySelector("#currentRoom").innerText.replace("# ","@")}.`:begNote=`Welcome to the beginning of ${document.querySelector("#currentRoom").innerText.replace("# ","#")} channel.`,beg=document.createElement("div"),beg.setAttribute("class","beg"),beg.innerText=begNote,document.querySelector(".messages-wrapper").appendChild(beg),i=0;i<e.length;i++){const n=document.querySelector(".messages-wrapper"),r=document.createElement("div");r.setAttribute("class","message-div");const a=document.createElement("img");a.setAttribute("class","avatar img-body"),a.setAttribute("src",`https://www.gravatar.com/avatar/${e[i][5]}?d=identicon&s=50`);const s=document.createElement("div");s.setAttribute("class","message");const c=document.createElement("div"),l=document.createElement("h4");l.setAttribute("class","inline-block"),l.innerText=e[i][4];const u=document.createElement("h6");u.setAttribute("class","inline-block"),u.innerText=moment.tz(e[i][2],t).calendar(),c.appendChild(l),c.appendChild(u),s.appendChild(c);const d=document.createElement("p");d.setAttribute("class","text-body"),1==e[i][6]?d.innerHTML=`has sent an attachment : <a class="attachment" href="${e[i][1]}" download='${e[i][7]}' title='Download ${e[i][7]}'>${e[i][7]}</a>`:d.innerText=e[i][1],s.appendChild(d),r.appendChild(a),r.appendChild(s),n.appendChild(r),o()}}catch(e){console.error(e.message)}document.querySelector(".messages-wrapper").scrollTop=document.querySelector(".messages-wrapper").scrollHeight,recentlyViewedMsgTime=document.querySelector(".messages-wrapper>.message-div:last-child h6").innerText}),$(".header").click(function(){var e=$(this);e.children(":first-child").hasClass("fa-angle-down")?(e.children(":first-child").removeClass("fa-angle-down"),e.children(":first-child").addClass("fa-angle-right"),e.next().hide("blind",600)):(e.children(":first-child").removeClass("fa-angle-right"),e.children(":first-child").addClass("fa-angle-down"),e.next().show("blind",600))}),$(".oc").click(function(){$(window).width()<=944&&($("#sidebar").toggle("slide"),$("#ui-dismiss").toggle("fade"),$("#ui-dismiss").click(function(){$("#sidebar").hide("slide"),$("#ui-dismiss").hide("fade")}),$("body").css("overflow","hidden"))}),$(window).on("resize",function(){var e=$(this);e.width()>=944?$("#sidebar").show("slide"):$("#sidebar").hide("slide")}),$("body").on("swiperight",function(){document.querySelector(".oc").click()}),$("#sidebar").on("swipeleft",function(){$("#sidebar").hide("slide"),$("#ui-dismiss").toggle("fade")}),$("#ui-dismiss").on("swipeleft",function(){$("#sidebar").hide("slide"),$("#ui-dismiss").toggle("fade")}),document.addEventListener("visibilitychange",function(){document.hidden||l.off()}),$("#unread").click(function(){document.querySelector(".messages-wrapper").scrollTop=document.querySelector(".messages-wrapper").scrollHeight,document.querySelector("#unread").style.display="none",document.querySelector(".chat-section").classList.remove("-unread"),unreadMsgCount=0,recentlyViewedMsgTime=""}),$("#theme").click(function(){document.body.classList.toggle("dark"),document.body.classList.contains("dark")?(localStorage.setItem("theme","dark"),document.querySelector(".themeTxt").innerHTML="Light Theme"):(localStorage.setItem("theme","light"),document.querySelector(".themeTxt").innerHTML="Dark Theme")}),$("#sound").click(function(){document.querySelector(".fa-volume-mute")?(localStorage.setItem("soundOff",1),document.querySelector("#sound").innerHTML='Sounds On <i class="fas fa-volume-up" style="padding-left:5px;"></i>'):(localStorage.setItem("soundOff",0),document.querySelector("#sound").innerHTML='Sounds Off <i class="fas fa-volume-mute" style="padding-left:5px;"></i>')}),$("#log-out").click(function(){Swal.fire({title:"Log out",text:"Are you sure you want to logout?",showCancelButton:!0,confirmButtonText:"Log out",confirmButtonColor:"#f04747"}).then(e=>{e.value&&(location.pathname="/logout")})}),$("#upload").click(function(){(async function(){const{value:e}=await Swal.fire({title:"Select file",input:"file",confirmButtonColor:"#4D384B",inputAttributes:{accept:"image/*,video/*,audio/*","aria-label":"Upload your file"}});if(e){if(e.size>1048576)return void Swal.fire("Can't proceed","File too large! (Only upto 10mb permitted)","error");const t=new FileReader;t.onload=(n=>{c.emit("file upload",{username:u,message:t.result,room:recentChatroom,roomId:recentChatroomId,file_name:e.name.split(/[^a-zA-Z0-9\-\_\.]/gi).join("_"),utc:Date.now(),is_file:!0}),Swal.fire({title:"Done",text:"Your file was successfully uploaded!",type:"success",timer:1500})}),t.readAsDataURL(e)}})()}),window.onpopstate=function(e){for(const t of document.querySelectorAll("li"))t.textContent.includes(e.state.channel)&&(t?(t.scrollIntoView({block:"start",behavior:"smooth"}),t.click()):console.log("Existing conversation not found!"))}});